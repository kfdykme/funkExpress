<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>Funk</title>
    <link rel="stylesheet" type="text/css" href="css/buttons.css" />
    <link rel="stylesheet" type="text/css" href="css/reset.css" />
    <link rel="stylesheet" type="text/css" href="css/main.css" />

    <script src="js/markdown.js"></script>
    <script src="js/jquery.js"></script>
    <script type="text/javascript">

    //ctrl + s 提交Form 同时覆盖浏览器的快捷键
        $(document).keydown(function(event){
     　　　if (event.ctrlKey && event.keyCode === 83){
            post('save')
               event.preventDefault();
     　　　 } else if (event.keyCode == 9){
               var textarea = document.getElementById('text-input');
               var position=textarea.selectionStart+4;//此处我用了两个空格表示缩进，其实无所谓几个，只要和下面保持一致就好了。
               textarea.value=textarea.value.substr(0,textarea.selectionStart)+'    '+textarea.value.substr(textarea.selectionStart);
               textarea.selectionStart=position;
               textarea.selectionEnd=position;
               textarea.focus();
               event.preventDefault();
            }
     　　});
        //
        // function tab(textarea){
        //
        //   if(event.keyCode == 9){
        //      var position=textarea.selectionStart+4;//此处我用了两个空格表示缩进，其实无所谓几个，只要和下面保持一致就好了。
        //      textarea.value=textarea.value.substr(0,textarea.selectionStart)+'    '+textarea.value.substr(textarea.selectionStart);
        //      textarea.selectionStart=position;
        //      textarea.selectionEnd=position;
        //      textarea.focus();
        //      event.preventDefault();
        //
        //    }else if (event.ctrlKey && event.keyCode === 83){
        //      post('save')
        //      event.preventDefault();
        //    }
       // }
    </script>
    <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=default"></script>
    <script type="text/javascript">
      function post(mode){
        var temp = document.createElement("form");
            temp.action = "/";
            temp.method = "post";
            temp.style.display = "none";
        var title = document.getElementById("post-title-input").value;
        var id = document.getElementById("post-id-input").value;
        var content = document.getElementById("text-input").value;
        if(mode == "write") id = uuid();
        var params ={
          id:id,
          title:title,
          content:content,
          mode:mode
        }

        for (var x in params ) {
            var opt = document.createElement("textarea");
            opt.name = x;
            opt.value = params[x];
            temp.appendChild(opt);
        }

        document.body.appendChild(temp);
        temp.submit();

        return temp;

      }

      function uuid() {
          var s = [];
          var hexDigits = "0123456789abcdef";
          for (var i = 0; i < 36; i++) {
              s[i] = hexDigits.substr(Math.floor(Math.random() * 0x10), 1);
          }
          s[14] = "4";  // bits 12-15 of the time_hi_and_version field to 0010
          s[19] = hexDigits.substr((s[19] & 0x3) | 0x8, 1);  // bits 6-7 of the clock_seq_hi_and_reserved to 01
          s[8] = s[13] = s[18] = s[23] = "-";

          var uuid = s.join("");
          return uuid;
      }
    </script>
  </head>
  <body>
      <div class="header">
        <button   class="button button-royal" id="button-write" onclick="post('write')">Write</button>
        <button   class="button button-royal" id="button-save" onclick="post('save')">Save</button>
        <div class="post-title">
          <p>Title</p>
            <input id="post-id-input" type="hidden" name="id" value="<%= post.id%>">
          <input id="post-title-input" type="text" name="title"  value="<%= post.post_title%>" />
        </div>
      </div>
      <div class="container">
          <div class="list">
            <% for(var i=0; i<posts.length; i++) { %>

              <form id="_form<%= i %>" method="post" action="/">
                <input type="hidden" name="id" value="<%= posts[i].id %>" />
                <input type="hidden" name="mode" value="write" />

                <p onclick="document.getElementById('_form<%= i %>').submit();" class="button" ><%= posts[i].post_title%></p>
              </form>
            <% } %>
          </div>
          <div class="editor">
            <div class="write">
              <textarea id="text-input" oninput="this.editor.update()" name="content"    ><%= post.post_content%> </textarea><br />
            </div>
            <div class="preview" id="preview">

            </div>
          </div>
      </div>
      <div class="footer">

      </div>
        <script type="text/javascript"
        src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
        </script>
        <script type="text/x-mathjax-config">
        MathJax.Hub.Config({
        tex2jax: {inlineMath: [['$','$'], ['\(','\)']]}
        });
        </script>
        <script>
          function Editor(input, preview) {
            this.update = function () {
              preview.innerHTML = markdown.toHTML(input.value);
            };
            input.editor = this;
            this.update();
            MathJax.Hub.Queue(["Typeset", MathJax.Hub]);
          }
          var $ = function (id) { return document.getElementById(id); };
          new Editor($("text-input"), $("preview"));
        //  tab($("text-input"));
        </script>


  </body>
</html>
